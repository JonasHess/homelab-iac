apiVersion: v1
kind: ConfigMap
metadata:
  name: restic-backup-paths
  namespace: {{ .Values.apps.restic.argocd.namespace | default "argocd" }}
  labels:
    app.kubernetes.io/name: restic-backup-paths
    app.kubernetes.io/component: backup
data:
  backup-paths.txt: |
{{- $backupPaths := list }}
{{- range $appName, $appConfig := .Values.apps }}
  {{- if $appConfig.enabled }}
    {{- if and $appConfig.argocd $appConfig.argocd.helm $appConfig.argocd.helm.values $appConfig.argocd.helm.values.generic $appConfig.argocd.helm.values.generic.deployment $appConfig.argocd.helm.values.generic.deployment.pvcMounts }}
      {{- range $mountName, $mountConfig := $appConfig.argocd.helm.values.generic.deployment.pvcMounts }}
        {{- if and $mountConfig.backup $mountConfig.hostPath }}
          {{- $backupPaths = append $backupPaths $mountConfig.hostPath }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $uniquePaths := $backupPaths | uniq | sortAlpha }}
{{- range $uniquePaths }}
    {{ . }}
{{- end }}