apiVersion: v1
kind: ConfigMap
metadata:
  name: restic-backup-paths
  namespace: {{ .Values.apps.restic.argocd.namespace | default "argocd" }}
  labels:
    app.kubernetes.io/name: restic-backup-paths
    app.kubernetes.io/component: backup
data:
  backup-paths.txt: |
{{- $backupPaths := list }}
{{- range $appName, $appConfig := .Values.apps }}
  {{- if $appConfig.enabled }}
    {{- if and $appConfig.argocd $appConfig.argocd.helm $appConfig.argocd.helm.values $appConfig.argocd.helm.values.generic $appConfig.argocd.helm.values.generic.deployment $appConfig.argocd.helm.values.generic.deployment.pvcMounts }}
      {{- range $mountName, $mountConfig := $appConfig.argocd.helm.values.generic.deployment.pvcMounts }}
        {{- if $mountConfig.backup }}
          {{- if or (eq $mountConfig.backup true) $mountConfig.backup.enabled }}
            {{- if $mountConfig.hostPath }}
              {{- $backupPaths = append $backupPaths $mountConfig.hostPath }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $uniquePaths := $backupPaths | uniq | sortAlpha }}
{{- range $uniquePaths }}
    {{ . }}
{{- end }}
  backup-config.yaml: |
    globalExcludes:
{{- if .Values.apps.restic.globalBackupRules }}
  {{- if .Values.apps.restic.globalBackupRules.exclude }}
    {{- range .Values.apps.restic.globalBackupRules.exclude }}
      - {{ . | quote }}
    {{- end }}
  {{- end }}
{{- end }}
    backups:
{{- range $appName, $appConfig := .Values.apps }}
  {{- if $appConfig.enabled }}
    {{- if and $appConfig.argocd $appConfig.argocd.helm $appConfig.argocd.helm.values $appConfig.argocd.helm.values.generic $appConfig.argocd.helm.values.generic.deployment $appConfig.argocd.helm.values.generic.deployment.pvcMounts }}
      {{- range $mountName, $mountConfig := $appConfig.argocd.helm.values.generic.deployment.pvcMounts }}
        {{- if $mountConfig.backup }}
          {{- if or (eq $mountConfig.backup true) $mountConfig.backup.enabled }}
            {{- if $mountConfig.hostPath }}
      - path: {{ $mountConfig.hostPath | quote }}
        app: {{ $appName | quote }}
        mount: {{ $mountName | quote }}
              {{- if ne $mountConfig.backup true }}
                {{- if $mountConfig.backup.include }}
        include:
                  {{- range $mountConfig.backup.include }}
          - {{ . | quote }}
                  {{- end }}
                {{- end }}
                {{- if $mountConfig.backup.exclude }}
        exclude:
                  {{- range $mountConfig.backup.exclude }}
          - {{ . | quote }}
                  {{- end }}
                {{- end }}
                {{- if $mountConfig.backup.excludeLargerThan }}
        excludeLargerThan: {{ $mountConfig.backup.excludeLargerThan | quote }}
                {{- end }}
                {{- if $mountConfig.backup.excludeCaches }}
        excludeCaches: {{ $mountConfig.backup.excludeCaches }}
                {{- end }}
                {{- if $mountConfig.backup.excludeIfPresent }}
        excludeIfPresent: {{ $mountConfig.backup.excludeIfPresent | quote }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}