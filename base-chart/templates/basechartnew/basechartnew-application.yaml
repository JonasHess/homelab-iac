{{- if .Values.apps.basechartnew.enabled -}}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: basechartnew
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  project: default
  source:
    repoURL: "https://github.com/JonasHess/homelab-iac.git"
    targetRevision: feature/refactor-apps
    path: base-chart-new
    helm:
      # Values file as block file
      valuesObject:

        # Global settings applied to all applications
        global:
          # Common domain configuration
          domain: hess.pm

          # Authentication settings
          akeyless:
            path: /hess.pm

          # Email settings for services
          email: Jonas@Hess.pm

          # DNS provider configuration
          cloudflare:
            email: Jonas@Hess.pm

          # Certificate management
          letsencrypt:
            email: Jonas@Hess.pm

          # Authentication provider
          traefik_forward_auth:
            oidc_client_id: "6e1bl5i55ao7bhhcufk85ussm"
            oidc_issuer_url: "https://cognito-idp.eu-central-1.amazonaws.com/eu-central-1_t9DQfKlSX"

          # Global ignore differences (applied to all apps unless overridden)
          ignoreDifferences:
            - group: ""
              kind: "Secret"
              jsonPointers:
                - "/data"

          # Notification settings
          notifications:
            # Default notification channels
            slack:
              channel: general
              token: "${SECRET:slack-token}"

        # All applications to be deployed by Argo CD
        apps:
          #--------------------------------------
          # INFRASTRUCTURE APPLICATIONS
          # These applications provide core infrastructure services
          # They should be deployed early in the sequence
          #--------------------------------------



          stirlingpdf:
            enabled: true
            argocd:
              targetRevision: feature/refactor-apps
              project: "default"
              syncWave: "10"  # Deploy after monitoring is available
              namespace: "argocd"
              labels:
                tier: "application"
                category: "documents"
              annotations:
                description: "StirlingPDF - PDF Processing and Management"
              helm:
                releaseName: "stirlingpdf-app"
                values:
                  generic:
                    deployment:
                      pvcMounts:
                        scanner:
                          hostPath: "/mnt/tank1/encrypted/apps/stirlingpdf/pipeline/watchedFolders/scanner"
                        paperlessconsume:
                          hostPath: "/mnt/tank1/encrypted/apps/paperlessngx/consume"


  destination:
    server: "https://kubernetes.default.svc"
    namespace: argocd
  syncPolicy:
    automated:
      allowEmpty: true
      prune: true
      selfHeal: true
    syncOptions:
      - allowEmpty=true
    retry:
      limit: 5 # number of failed sync attempt retries; unlimited number of attempts if less than 0
      backoff:
        duration: 5s # the amount to back off. Default unit is seconds, but could also be a duration (e.g. "2m", "1h")
        factor: 2 # a factor to multiply the base duration after each failed retry
        maxDuration: 1m # the maximum amount of time allowed for the backoff strategy
{{- end -}}