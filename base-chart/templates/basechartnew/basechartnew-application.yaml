{{- if .Values.apps.basechartnew.enabled -}}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: basechartnew
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  project: default
  source:
    repoURL: "https://github.com/JonasHess/homelab-iac.git"
    targetRevision: feature/refactor-apps
    path: base-chart-new
    helm:
      # Values file as block file
      valuesObject:

        # Global settings applied to all applications
        global:
          # Common domain configuration
          domain: hess.pm

          # Authentication settings
          akeyless:
            path: /hess.pm

          # Email settings for services
          email: Jonas@Hess.pm

          # DNS provider configuration
          cloudflare:
            email: Jonas@Hess.pm

          # Certificate management
          letsencrypt:
            email: Jonas@Hess.pm

          # Authentication provider
          traefik_forward_auth:
            oidc_client_id: "6e1bl5i55ao7bhhcufk85ussm"
            oidc_issuer_url: "https://cognito-idp.eu-central-1.amazonaws.com/eu-central-1_t9DQfKlSX"

          # Global ignore differences (applied to all apps unless overridden)
          ignoreDifferences:
            - group: ""
              kind: "Secret"
              jsonPointers:
                - "/data"

          # Notification settings
          notifications:
            # Default notification channels
            slack:
              channel: general
              token: "${SECRET:slack-token}"



        # Projects configuration for Argo CD
        # Define different projects with their permissions and constraints

  {{/*      projects:*/}}
  {{/*        # Infrastructure project for core services*/}}
  {{/*        infrastructure:*/}}
  {{/*          enabled: false*/}}
  {{/*          description: "Core infrastructure components"*/}}
  {{/*          labels:*/}}
  {{/*            tier: infrastructure*/}}
  {{/*          # Allow only specific repositories*/}}
  {{/*          sourceRepos:*/}}
  {{/*            - "https://github.com/JonasHess/homelab-iac.git"*/}}
  {{/*            - "https://charts.jetstack.io"  # Cert-manager Helm repo*/}}
  {{/*          # Allow specific clusters and namespaces*/}}
  {{/*          destinations:*/}}
  {{/*            - server: "https://kubernetes.default.svc"*/}}
  {{/*              namespace: "cert-manager"*/}}
  {{/*            - server: "https://kubernetes.default.svc"*/}}
  {{/*              namespace: "traefik"*/}}
  {{/*            - server: "https://kubernetes.default.svc"*/}}
  {{/*              namespace: "kube-system"*/}}
  {{/*          # Allow specific cluster-wide resources*/}}
  {{/*          clusterResourceWhitelist:*/}}
  {{/*            - group: "apiextensions.k8s.io"*/}}
  {{/*              kind: "CustomResourceDefinition"*/}}
  {{/*            - group: "rbac.authorization.k8s.io"*/}}
  {{/*              kind: "ClusterRole"*/}}
  {{/*            - group: "rbac.authorization.k8s.io"*/}}
  {{/*              kind: "ClusterRoleBinding"*/}}
  {{/*          # Define project roles for access control*/}}
  {{/*          roles:*/}}
  {{/*            - name: admin*/}}
  {{/*              description: Admin role for infrastructure team*/}}
  {{/*              policies:*/}}
  {{/*                - p, proj:infrastructure:admin, applications, *, infrastructure/*, allow*/}}
  {{/*              groups:*/}}
  {{/*                - infrastructure-admins*/}}
  {{/*            - name: readonly*/}}
  {{/*              description: Read-only access*/}}
  {{/*              policies:*/}}
  {{/*                - p, proj:infrastructure:readonly, applications, get, infrastructure/*, allow*/}}
  {{/*              groups:*/}}
  {{/*                - all-developers*/}}
  {{/*      */}}
  {{/*        # Monitoring project for observability tools*/}}
  {{/*        monitoring:*/}}
  {{/*          enabled: false*/}}
  {{/*          description: "Monitoring and observability tools"*/}}
  {{/*          labels:*/}}
  {{/*            tier: monitoring*/}}
  {{/*          sourceRepos:*/}}
  {{/*            - "https://github.com/JonasHess/homelab-iac.git"*/}}
  {{/*            - "https://prometheus-community.github.io/helm-charts"*/}}
  {{/*            - "https://grafana.github.io/helm-charts"*/}}
  {{/*          destinations:*/}}
  {{/*            - server: "https://kubernetes.default.svc"*/}}
  {{/*              namespace: "monitoring"*/}}
  {{/*          # Define project roles*/}}
  {{/*          roles:*/}}
  {{/*            - name: admin*/}}
  {{/*              description: Admin role for monitoring team*/}}
  {{/*              policies:*/}}
  {{/*                - p, proj:monitoring:admin, applications, *, monitoring/*, allow*/}}
  {{/*              groups:*/}}
  {{/*                - monitoring-admins*/}}
  {{/*            - name: readonly*/}}
  {{/*              description: Read-only access*/}}
  {{/*              policies:*/}}
  {{/*                - p, proj:monitoring:readonly, applications, get, monitoring/*, allow*/}}
  {{/*              groups:*/}}
  {{/*                - all-developers*/}}
  {{/*      */}}
  {{/*        # Applications project for business applications*/}}
  {{/*        applications:*/}}
  {{/*          enabled: false*/}}
  {{/*          description: "Business applications"*/}}
  {{/*          labels:*/}}
  {{/*            tier: applications*/}}
  {{/*          sourceRepos:*/}}
  {{/*            - "https://github.com/JonasHess/homelab-iac.git"*/}}
  {{/*          destinations:*/}}
  {{/*            - server: "https://kubernetes.default.svc"*/}}
  {{/*              namespace: "photos"*/}}
  {{/*            - server: "https://kubernetes.default.svc"*/}}
  {{/*              namespace: "file-storage"*/}}
  {{/*          # No cluster-wide resources allowed*/}}
  {{/*          clusterResourceWhitelist: []*/}}
  {{/*          # Define project roles*/}}
  {{/*          roles:*/}}
  {{/*            - name: admin*/}}
  {{/*              description: Admin role for application team*/}}
  {{/*              policies:*/}}
  {{/*                - p, proj:applications:admin, applications, *, applications/*, allow*/}}
  {{/*              groups:*/}}
  {{/*                - app-admins*/}}
  {{/*            - name: developer*/}}
  {{/*              description: Developer access*/}}
  {{/*              policies:*/}}
  {{/*                - p, proj:applications:developer, applications, get, applications/*, allow*/}}
  {{/*                - p, proj:applications:developer, applications, sync, applications/*, allow*/}}
  {{/*              groups:*/}}
  {{/*                - developers*/}}
  {{/*      */}}
  {{/*        # DevTools project for development tools*/}}
  {{/*        devtools:*/}}
  {{/*          enabled: false*/}}
  {{/*          description: "Development tools and utilities"*/}}
  {{/*          labels:*/}}
  {{/*            tier: devtools*/}}
  {{/*          sourceRepos:*/}}
  {{/*            - "https://github.com/JonasHess/homelab-iac.git"*/}}
  {{/*          destinations:*/}}
  {{/*            - server: "https://kubernetes.default.svc"*/}}
  {{/*              namespace: "devtools"*/}}
  {{/*            - server: "https://kubernetes.dev-cluster.svc"*/}}
  {{/*              namespace: "devtools"*/}}
  {{/*          # Define project roles*/}}
  {{/*          roles:*/}}
  {{/*            - name: admin*/}}
  {{/*              description: Admin role for DevOps team*/}}
  {{/*              policies:*/}}
  {{/*                - p, proj:devtools:admin, applications, *, devtools/*, allow*/}}
  {{/*              groups:*/}}
  {{/*                - devops-admins*/}}


        # All applications to be deployed by Argo CD
        apps:
          #--------------------------------------
          # INFRASTRUCTURE APPLICATIONS
          # These applications provide core infrastructure services
          # They should be deployed early in the sequence
          #--------------------------------------



          stirlingpdf:
            enabled: true
            argocd:
              project: "default"
              syncWave: "10"  # Deploy after monitoring is available
              namespace: "argocd"
              labels:
                tier: "application"
                category: "documents"
              annotations:
                description: "StirlingPDF - PDF Processing and Management"
              info:
                - name: "Web UI"
                  value: "https://photos.{{.Values.global.domain}}"
              helm:
                releaseName: "stirlingpdf-app"
                values:
                  generic:
                    deployment:
                      pvcMounts:
                        scanner:
                          hostPath: "/mnt/tank1/encrypted/apps/stirlingpdf/pipeline/watchedFolders/scanner"
                        paperlessconsume:
                          hostPath: "/mnt/tank1/encrypted/apps/paperlessngx/consume"


  destination:
    server: "https://kubernetes.default.svc"
    namespace: argocd
  syncPolicy:
    automated:
      allowEmpty: true
      prune: true
      selfHeal: true
    syncOptions:
      - allowEmpty=true
    retry:
      limit: 5 # number of failed sync attempt retries; unlimited number of attempts if less than 0
      backoff:
        duration: 5s # the amount to back off. Default unit is seconds, but could also be a duration (e.g. "2m", "1h")
        factor: 2 # a factor to multiply the base duration after each failed retry
        maxDuration: 1m # the maximum amount of time allowed for the backoff strategy
{{- end -}}