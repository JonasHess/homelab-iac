{{- if .Values.apps.homer.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: homer-config
  namespace: {{ .Values.apps.homer.argocd.namespace | default "argocd" }}
  labels:
    app: homer
data:
  config.yml: |
    ---
    title: "Home Server Dashboard"
    subtitle: "Your Self-Hosted Applications Hub"
    logo: "assets/icons/homer.png"

    # Theme settings with improved aesthetics
    theme: slate
    colors:
      light:
        primary: "#3367d6"
        background: "#f5f5f5"
        card-background: "#ffffff"
        text: "#363636"
        highlight-primary: "#4285f4"
      dark:
        primary: "#5c6bc0"
        background: "#131313"
        card-background: "#1c1c1c"
        text: "#eaeaea"
        highlight-primary: "#7986cb"

    # Customization options
    header: true
    footer: '<p>Created with <span class="has-text-danger">‚ù§</span> by Kubernetes | <a href="https://github.com/bastienwirtz/homer" target="_blank">Homer Project</a></p>'
    defaults:
      layout: columns
      colorTheme: auto

    # Welcome message with markdown support
    message:
      style: "is-info"
      title: "Welcome to Your Home Server!"
      content: "All your self-hosted applications are organized below. Use the **search bar** to quickly find what you need."

    # Navigation
    links:
      - name: "GitHub"
        icon: "fab fa-github"
        url: "https://github.com/bastienwirtz/homer"
        target: "_blank"
      - name: "Documentation"
        icon: "fas fa-book"
        url: "https://github.com/bastienwirtz/homer/blob/main/docs/configuration.md"
        target: "_blank"
      - name: "Refresh"
        icon: "fas fa-sync"
        url: "/"

    # Services organized by groups defined in values.yaml
    services:
      {{- $groups := dict }}

      {{- /* First collect all apps into group buckets */ -}}
      {{- range $appName, $appConfig := .Values.apps }}
        {{- if and $appConfig.enabled $appConfig.homer }}
          {{- $group := "Other Applications" }}
          {{- $icon := "fas fa-cubes" }}

          {{- if $appConfig.homer.group }}
            {{- $group = $appConfig.homer.group.name | default "Other Applications" }}
            {{- $icon = $appConfig.homer.group.icon | default "fas fa-cubes" }}
          {{- end }}

          {{- /* Initialize the group if it doesn't exist */ -}}
          {{- if not (hasKey $groups $group) }}
            {{- $_ := set $groups $group (dict "icon" $icon "items" list) }}
          {{- end }}

          {{- /* Add the app to the group's items */ -}}
          {{- $item := dict "name" ($appConfig.argocd.description | default $appName)
                           "logo" ($appConfig.homer.logo | default (printf "assets/icons/%s.png" $appName))
                           "subtitle" ($appConfig.homer.subtitle | default "")
                           "tag" ($appConfig.homer.tag | default "")
                           "url" ($appConfig.homer.url | default (printf "https://%s.%s" $appName $.Values.global.domain))
                           "target" "_blank" }}

          {{- $groupItems := (index $groups $group).items }}
          {{- $groupItems = append $groupItems $item }}
          {{- $_ := set (index $groups $group) "items" $groupItems }}
        {{- end }}
      {{- end }}

      {{- /* Now output the groups */ -}}
      {{- range $groupName, $groupConfig := $groups }}
      - name: "{{ $groupName }}"
        icon: "{{ $groupConfig.icon }}"
        items: {{ $groupConfig.items | toJson }}
      {{- end }}

    # Custom stylesheet for additional customization
    stylesheet:
      - "assets/custom.css"
{{- end }}