# Generic chart configuration for external secrets, ingress, and PVCs
generic:
  externalSecrets:
    nextcloud-credentials:
      - admin-user: "/nextcloud/admin-user"
      - admin-password: "/nextcloud/admin-password"
      - postgres-user: "/nextcloud/postgres-user"
      - postgres-password: "/nextcloud/postgres-password"

  ingress:
    https:
      # API routes that bypass OAuth (for mobile apps, sync clients, WebDAV)
      - subdomain: nextcloud
        port: 8080
        service: nextcloud
        matchSuffix: "&& (PathPrefix(`/remote.php`) || PathPrefix(`/ocs`) || PathPrefix(`/status.php`) || PathPrefix(`/cron.php`) || PathPrefix(`/apps/richdocuments/wopi`))"
        priority: 20
      # Main Nextcloud UI with OAuth protection
      - subdomain: nextcloud
        port: 8080
        service: nextcloud
        middlewares:
          - oauth2-proxy
        priority: 10
      # Collabora WOPI discovery and document endpoints (needed for Nextcloud integration)
      - subdomain: office
        port: 9980
        service: nextcloud-collabora
        matchSuffix: "&& (PathPrefix(`/hosting/discovery`) || PathPrefix(`/hosting/capabilities`) || PathPrefix(`/cool`) || PathPrefix(`/browser`) || PathPrefix(`/lool`) || PathPrefix(`/loleaflet`))"
        priority: 20
      # Collabora fallback with OAuth protection
      - subdomain: office
        port: 9980
        service: nextcloud-collabora
        middlewares:
          - oauth2-proxy
        priority: 10

  persistentVolumeClaims:
    data:
      hostPath: /mnt/storage/nextcloud/data
    postgresql:
      hostPath: /mnt/storage/nextcloud/postgresql

# Nextcloud upstream chart configuration
nextcloud:
  image:
    repository: nextcloud
    tag: 32.0.5-apache
    pullPolicy: IfNotPresent

  replicaCount: 1

  nextcloud:
    host: nextcloud.home-server.dev

    # Admin user - password from external secret
    username: admin
    existingSecret:
      enabled: true
      secretName: nextcloud-credentials
      usernameKey: admin-user
      passwordKey: admin-password

    # Trusted domains (include internal K8s service name for Collabora callbacks)
    trustedDomains:
      - nextcloud.home-server.dev
      - office.home-server.dev
      - nextcloud

    # PHP configuration for performance
    phpConfigs:
      uploadLimit.ini: |
        upload_max_filesize = 16G
        post_max_size = 16G
        max_input_time = 3600
        max_execution_time = 3600
      www.conf: |
        [www]
        pm = dynamic
        pm.max_children = 120
        pm.start_servers = 12
        pm.min_spare_servers = 6
        pm.max_spare_servers = 18

    # Proxy settings via environment variables (config.php is auto-generated)
    # NOTE: Environments should override the ENTIRE extraEnv array in their values.yaml
    # because Helm arrays replace (not merge). Include all vars when overriding.
    extraEnv:
      - name: TRUSTED_PROXIES
        value: "10.0.0.0/8"
      - name: OVERWRITEPROTOCOL
        value: "https"
      - name: NC_loglevel
        value: "2"
      # Internal service URL for Nextcloud -> Collabora server communication
      - name: COLLABORA_URL
        value: "http://nextcloud-collabora:9980"
      # External URL for browser to access Collabora
      - name: COLLABORA_PUBLIC_URL
        value: "https://office.home-server.dev"
      # Internal callback URL for Collabora -> Nextcloud communication
      - name: NEXTCLOUD_CALLBACK_URL
        value: "http://nextcloud:8080"

    # Post-installation hook to install and configure Nextcloud Office (Collabora)
    hooks:
      post-installation: |
        echo "Installing Nextcloud Office app..."
        php /var/www/html/occ app:install richdocuments || true
        echo "Configuring Collabora server..."
        echo "  WOPI URL: ${COLLABORA_URL}"
        echo "  Public URL: ${COLLABORA_PUBLIC_URL}"
        echo "  Callback URL: ${NEXTCLOUD_CALLBACK_URL}"
        # Set WOPI URL first (activate-config doesn't have an option for this)
        php /var/www/html/occ config:app:set richdocuments wopi_url --value="${COLLABORA_URL}"
        # Use activate-config to fetch discovery and set callback URL
        # This command fetches discovery XML, validates connectivity, and configures public_wopi_url
        php /var/www/html/occ richdocuments:activate-config --callback-url="${NEXTCLOUD_CALLBACK_URL}" || true
        echo "Nextcloud Office configured!"

  # Ingress disabled - using generic chart IngressRoute
  ingress:
    enabled: false

  # Persistence - use generic chart PVC
  persistence:
    enabled: true
    existingClaim: nextcloud-data-pvc

  # Internal database disabled
  internalDatabase:
    enabled: false

  # External PostgreSQL from subchart
  externalDatabase:
    enabled: true
    type: postgresql
    host: nextcloud-postgresql
    database: nextcloud
    existingSecret:
      enabled: true
      secretName: nextcloud-credentials
      usernameKey: postgres-user
      passwordKey: postgres-password

  # PostgreSQL subchart
  postgresql:
    enabled: true
    global:
      postgresql:
        auth:
          existingSecret: nextcloud-credentials
          secretKeys:
            userPasswordKey: postgres-password
            adminPasswordKey: postgres-password
    primary:
      persistence:
        enabled: true
        existingClaim: nextcloud-postgresql-pvc

  # Redis subchart for caching
  redis:
    enabled: true
    auth:
      enabled: false
    architecture: standalone
    master:
      persistence:
        enabled: false

  # Collabora (Nextcloud Office)
  collabora:
    enabled: true
    collabora:
      # Allow both external domain and internal K8s service for WOPI callbacks
      aliasgroups:
        - host: "https://nextcloud.home-server.dev:443"
        - host: "http://nextcloud:8080"
      # CSP frame-ancestors must include Nextcloud domain to allow iframe embedding
      # security.capabilities=false disables seccomp/capabilities checks for Kubernetes compatibility
      extra_params: --o:ssl.enable=false --o:ssl.termination=true --o:net.frame_ancestors=nextcloud.home-server.dev --o:security.capabilities=false
      DONT_GEN_SSL_CERT: true
      server_name: office.home-server.dev
    # Required for Collabora to work in Kubernetes without privileged mode
    securityContext:
      allowPrivilegeEscalation: true
      capabilities:
        add:
          - MKNOD
          - SYS_CHROOT
          - FOWNER
    ingress:
      enabled: false

  # Cron job for background tasks
  cronjob:
    enabled: true

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 2Gi

  # Probes
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3
  startupProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30
