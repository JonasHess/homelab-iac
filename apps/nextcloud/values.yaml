# Collabora URL configuration - computed from global.domain
collaboraConfig:
  nextcloudSubdomain: nextcloud
  collaboraSubdomain: office

# Generic chart configuration for external secrets, ingress, and PVCs
generic:
  externalSecrets:
    nextcloud-credentials:
      - admin-user: "/nextcloud/admin-user"
      - admin-password: "/nextcloud/admin-password"
      - postgres-user: "/nextcloud/postgres-user"
      - postgres-password: "/nextcloud/postgres-password"

  ingress:
    https:
      # API routes that bypass OAuth (for mobile apps, sync clients, WebDAV)
      - subdomain: nextcloud
        port: 8080
        service: nextcloud
        matchSuffix: "&& (PathPrefix(`/remote.php`) || PathPrefix(`/ocs`) || PathPrefix(`/status.php`) || PathPrefix(`/cron.php`) || PathPrefix(`/apps/richdocuments`) || PathPrefix(`/index.php/login`) || PathPrefix(`/login/v2`))"
        priority: 20
      # Main Nextcloud UI with OAuth protection
      - subdomain: nextcloud
        port: 8080
        service: nextcloud
        middlewares:
          - oauth2-proxy
        priority: 10
      # Collabora WOPI discovery and document endpoints (needed for Nextcloud integration)
      - subdomain: office
        port: 9980
        service: nextcloud-collabora
        matchSuffix: "&& (PathPrefix(`/hosting/discovery`) || PathPrefix(`/hosting/capabilities`) || PathPrefix(`/cool`) || PathPrefix(`/browser`) || PathPrefix(`/lool`) || PathPrefix(`/loleaflet`))"
        priority: 20
      # Collabora fallback with OAuth protection
      - subdomain: office
        port: 9980
        service: nextcloud-collabora
        middlewares:
          - oauth2-proxy
        priority: 10

  persistentVolumeClaims:
    data:
      hostPath: /mnt/storage/nextcloud/data
    postgresql:
      hostPath: /mnt/storage/nextcloud/postgresql

# Nextcloud upstream chart configuration
nextcloud:
  image:
    repository: nextcloud
    tag: 32.0.6-apache
    pullPolicy: IfNotPresent

  replicaCount: 1

  nextcloud:
    # Host is computed from global.domain - set via NEXTCLOUD_TRUSTED_DOMAINS env var
    host: localhost

    # Admin user - password from external secret
    username: admin
    existingSecret:
      enabled: true
      secretName: nextcloud-credentials
      usernameKey: admin-user
      passwordKey: admin-password

    # Trusted domains computed from global.domain via ConfigMap
    trustedDomains:
      - localhost

    # PHP configuration for performance
    phpConfigs:
      uploadLimit.ini: |
        upload_max_filesize = 16G
        post_max_size = 16G
        max_input_time = 3600
        max_execution_time = 3600
      www.conf: |
        [www]
        pm = dynamic
        pm.max_children = 120
        pm.start_servers = 12
        pm.min_spare_servers = 6
        pm.max_spare_servers = 18

    # Environment variables - domain values computed from global.domain via ConfigMap
    extraEnv:
      - name: TRUSTED_PROXIES
        value: "0.0.0.0/0"
      - name: NEXTCLOUD_URL
        valueFrom:
          configMapKeyRef:
            name: nextcloud-collabora-config
            key: NEXTCLOUD_URL
      - name: NC_TRUSTED_DOMAINS
        valueFrom:
          configMapKeyRef:
            name: nextcloud-collabora-config
            key: NEXTCLOUD_TRUSTED_DOMAINS
      - name: COLLABORA_URL
        valueFrom:
          configMapKeyRef:
            name: nextcloud-collabora-config
            key: COLLABORA_URL
      - name: COLLABORA_PUBLIC_URL
        valueFrom:
          configMapKeyRef:
            name: nextcloud-collabora-config
            key: COLLABORA_PUBLIC_URL
      - name: NEXTCLOUD_CALLBACK_URL
        valueFrom:
          configMapKeyRef:
            name: nextcloud-collabora-config
            key: NEXTCLOUD_CALLBACK_URL

    # Post-installation hook to configure trusted domains and Collabora
    hooks:
      post-installation: |
        #!/bin/sh
        echo "Configuring trusted domains..."
        i=0
        for DOMAIN in ${NC_TRUSTED_DOMAINS}; do
          php /var/www/html/occ config:system:set trusted_domains "$i" --value="$DOMAIN"
          i=$((i+1))
        done

        echo "Configuring URL overrides for reverse proxy..."
        php /var/www/html/occ config:system:set overwrite.cli.url --value="${NEXTCLOUD_URL}"

        echo "Configuring Nextcloud Office (Collabora)..."
        php /var/www/html/occ app:install richdocuments || true
        php /var/www/html/occ config:app:set richdocuments wopi_url --value="${COLLABORA_URL}"
        php /var/www/html/occ config:app:set richdocuments public_wopi_url --value="${COLLABORA_PUBLIC_URL}"
        php /var/www/html/occ richdocuments:activate-config --callback-url="${NEXTCLOUD_CALLBACK_URL}" || true
        echo "Nextcloud Office configured!"

  # Ingress disabled - using generic chart IngressRoute
  ingress:
    enabled: false

  # Persistence - use generic chart PVC
  persistence:
    enabled: true
    existingClaim: nextcloud-data-pvc

  # Internal database disabled
  internalDatabase:
    enabled: false

  # External PostgreSQL from subchart
  externalDatabase:
    enabled: true
    type: postgresql
    host: nextcloud-postgresql
    database: nextcloud
    existingSecret:
      enabled: true
      secretName: nextcloud-credentials
      usernameKey: postgres-user
      passwordKey: postgres-password

  # PostgreSQL subchart
  postgresql:
    enabled: true
    global:
      postgresql:
        auth:
          existingSecret: nextcloud-credentials
          secretKeys:
            userPasswordKey: postgres-password
            adminPasswordKey: postgres-password
    primary:
      persistence:
        enabled: true
        existingClaim: nextcloud-postgresql-pvc

  # Redis subchart for caching
  redis:
    enabled: true
    auth:
      enabled: false
    architecture: standalone
    master:
      persistence:
        enabled: false

  # Collabora (Nextcloud Office) - domain values computed from global.domain via ConfigMap
  collabora:
    enabled: true
    collabora:
      DONT_GEN_SSL_CERT: true
      # Domain-specific values via env from ConfigMap
      env:
        - name: aliasgroup1
          valueFrom:
            configMapKeyRef:
              name: nextcloud-collabora-config
              key: COLLABORA_ALIASGROUP1
        - name: aliasgroup2
          valueFrom:
            configMapKeyRef:
              name: nextcloud-collabora-config
              key: COLLABORA_ALIASGROUP2
        - name: server_name
          valueFrom:
            configMapKeyRef:
              name: nextcloud-collabora-config
              key: COLLABORA_SERVER_NAME
        - name: extra_params
          valueFrom:
            configMapKeyRef:
              name: nextcloud-collabora-config
              key: COLLABORA_EXTRA_PARAMS
    securityContext:
      allowPrivilegeEscalation: true
      capabilities:
        add:
          - MKNOD
          - SYS_CHROOT
          - FOWNER
    ingress:
      enabled: false

  # Cron job for background tasks
  cronjob:
    enabled: true

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 2Gi

  # Probes
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3
  startupProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30
