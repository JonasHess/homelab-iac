global:
  domain: ~ # example.com
  oauth2_proxy:
    oidc_client_id: ~ # your-cognito-client-id
    oidc_issuer_url: ~ # https://accounts.google.com
  akeyless:
    path: ~ # /path/to/secrets
additionalExposedPorts:
  sftpgo:
    port: 2222
    protocol: TCP
  ftp:
    port: 2121
    protocol: TCP
  dns:
    port: 53
    protocol: UDP
loadBalancerIP: null
generic:
  persistentVolumeClaims:
    data:
      hostPath: ~ # /mnt/somewhere/unencrypted/apps/traefik/data
      backup:
        enabled: true
middlewares:
  cloudflare:
    allowedCIDRs: []

oauth2-proxy:
  config:
    existingSecret: oauth2-proxy
  # extraArgs must be fully specified in environment-specific values (homelab_environments)
  # due to Helm's map replacement behavior (not merged, but replaced entirely)
  # Required args: provider, oidc-issuer-url, upstream, reverse-proxy, cookie-domain,
  #                cookie-samesite, cookie-secure, whitelist-domain, email-domain,
  #                redirect-url, custom-templates-dir
  deploymentAnnotations:
    reloader.stakater.com/auto: "true"
  extraVolumes:
    - name: custom-templates
      configMap:
        name: oauth2-proxy-templates
  extraVolumeMounts:
    - name: custom-templates
      mountPath: /templates
  extraObjects:
    # ConfigMap with custom sign_in.html that auto-redirects
    - apiVersion: v1
      kind: ConfigMap
      metadata:
        name: oauth2-proxy-templates
        namespace: '{{ .Release.Namespace }}'
      data:
        sign_in.html: |
          <!DOCTYPE html>
          <html>
          <head>
            <title>Redirecting...</title>
            <meta http-equiv="refresh" content="0;url=https://auth.{{ .Values.global.domain }}/oauth2/start?rd={{`{{.Redirect}}`}}">
          </head>
          <body>
            <p>Redirecting to login...</p>
          </body>
          </html>
    # ForwardAuth middleware - checks if user is authenticated
    - apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: oauth2-proxy-auth
        namespace: '{{ .Release.Namespace }}'
        annotations:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
      spec:
        forwardAuth:
          address: http://{{ .Release.Name }}-oauth2-proxy.{{ .Release.Namespace }}.svc.cluster.local/oauth2/auth
          trustForwardHeader: true
          authResponseHeaders:
            - X-Auth-Request-User
            - X-Auth-Request-Email
    # Errors middleware - catches 401 and shows sign-in page with auto-redirect
    - apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: oauth2-proxy-errors
        namespace: '{{ .Release.Namespace }}'
        annotations:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
      spec:
        errors:
          status:
            - "401"
          query: /oauth2/sign_in?rd={url}
          service:
            name: '{{ .Release.Name }}-oauth2-proxy'
            port: 80
    # Chain middleware - this is what apps should reference
    - apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: oauth2-proxy
        namespace: '{{ .Release.Namespace }}'
        annotations:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
      spec:
        chain:
          middlewares:
            - name: oauth2-proxy-errors
            - name: oauth2-proxy-auth
    - apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: oauth2-proxy
        namespace: '{{ .Release.Namespace }}'
        annotations:
          argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
      spec:
        entryPoints:
          - websecure
        routes:
          - kind: Rule
            match: Host(`auth.{{ .Values.global.domain }}`)
            services:
              - name: '{{ .Release.Name }}-oauth2-proxy'
                port: 80
        tls:
          certResolver: cloudflare
