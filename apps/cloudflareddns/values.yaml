cron_job: 5 * * * *
generic:
  deployment:
    image: zimmermq/cloudflare-ddns:main
    envFrom:
      secretRef: cloudflare-ddns-api-credentials
      configMapRef: cloudflare-ddns-config-map
    initContainers:
      - name: wait-for-network
        image: busybox:1.36
        command: ['sh', '-c']
        args:
          - |
            echo "Waiting for network connectivity..."
            echo "Testing DNS resolution first..."
            for i in 1 2 3 4 5 6 7 8 9 10; do
              echo "Attempt $i/10 - $(date)"
              if nslookup api.cloudflare.com >/dev/null 2>&1; then
                echo "DNS resolution works, testing HTTPS connectivity..."
                if wget -q --spider --timeout=3 https://api.cloudflare.com/client/v4/user/tokens/verify 2>/dev/null; then
                  echo "Network is ready!"
                  exit 0
                else
                  echo "DNS works but HTTPS connection failed"
                fi
              else
                echo "DNS resolution failed"
              fi
              echo "Sleeping 3 seconds..."
              sleep 3
            done
            echo "Network failed to become ready after 10 attempts"
            exit 1
