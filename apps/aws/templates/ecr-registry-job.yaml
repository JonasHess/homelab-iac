{{- range .Values.ecrRegistries }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ecr-registry-helper-immediate-{{ .name }}
  namespace: {{ $.Release.Namespace }}
spec:
  backoffLimit: {{ $.Values.cronJob.backoffLimit }}
  template:
    spec:
      serviceAccountName: {{ $.Values.serviceAccount.name }}
      containers:
      - name: ecr-registry-helper
        image: {{ $.Values.image.repository }}:{{ $.Values.image.tag }}
        imagePullPolicy: {{ $.Values.image.pullPolicy }}
        resources:
          {{- toYaml $.Values.resources | nindent 10 }}
        envFrom:
          - secretRef:
              name: ecr-registry-helper-secrets-{{ .name }}
          - configMapRef:
              name: ecr-registry-helper-cm-{{ .name }}
        command:
          - /bin/bash
          - -c
          - |-
            ECR_TOKEN="$(aws ecr get-login-password --region ${AWS_REGION})"
            kubectl delete secret --ignore-not-found $DOCKER_SECRET_NAME -n $NAMESPACE_NAME
            kubectl create secret docker-registry $DOCKER_SECRET_NAME \
              --docker-server=https://${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com \
              --docker-username=AWS \
              --docker-password=${ECR_TOKEN} \
              --namespace=$NAMESPACE_NAME
            echo "Secret $DOCKER_SECRET_NAME was successfully updated at $(date)"
      restartPolicy: Never
{{- end }}
